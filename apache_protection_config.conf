# Пример конфигурации Apache для защиты от DDoS на основе результатов тестирования
# Разместите в /etc/apache2/apache2.conf или в отдельном файле в /etc/apache2/conf-available/

# Включение модулей для защиты
# LoadModule evasive24_module modules/mod_evasive24.so
# LoadModule reqtimeout_module modules/mod_reqtimeout.so
# LoadModule security_module modules/mod_security.so

# Защита от Slowloris
Timeout 10
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15

# Ограничение размера тела запроса
LimitRequestBody 10485760  # 10MB

# Базовые настройки производительности
ServerTokens Prod
ServerSignature Off
HostnameLookups Off

# Настройки модуля mod_reqtimeout (защита от Slowloris)
<IfModule mod_reqtimeout.c>
    RequestReadTimeout header=10-40,MinRate=500 body=10-40,MinRate=500
</IfModule>

# Настройки модуля mod_evasive (защита от DDoS)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSEmailNotify      admin@your-domain.com
    DOSSystemCommand    "su - someuser -c '/sbin/... %s ...'"
    DOSLogDir           /var/log/mod_evasive
    DOSWhitelist        127.0.0.1
</IfModule>

# Настройки модуля mod_security (WAF)
<IfModule mod_security2.c>
    SecRuleEngine On
    SecRequestBodyLimit 10485760
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject
    SecResponseBodyLimit 1048576
    SecResponseBodyMimeType text/plain text/html text/xml
    SecResponseBodyAccess Off
</IfModule>

# Виртуальный хост
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/html

    # Ограничение соединений (требует mod_limitipconn)
    <IfModule mod_limitipconn.c>
        <Location />
            MaxConnPerIP 20
        </Location>
    </IfModule>

    # Rate Limiting (требует mod_ratelimit)
    <IfModule mod_ratelimit.c>
        <Location />
            SetOutputFilter RATE_LIMIT
            SetEnv rate-limit 400
        </Location>
    </IfModule>

    # Защита директорий
    <Directory /var/www/html>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # Блокировка определенных путей
    <LocationMatch "/(\.|htaccess|htpasswd)">
        Require all denied
    </LocationMatch>

    # Логирование
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

# Пример для HTTPS (SSL)
# <VirtualHost *:443>
#     ServerName your-domain.com
#     DocumentRoot /var/www/html
#
#     SSLEngine on
#     SSLCertificateFile /path/to/cert.pem
#     SSLCertificateKeyFile /path/to/key.pem
#
#     # Те же настройки защиты...
# </VirtualHost>

